<!DOCTYPE html>

<html id="html" lang="en">

	<head>
		<meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Map</title>

		<script type="text/javascript" src="http://maps.stamen.com/js/tile.stamen.js?v1.3.0"></script>
		<script src="./leaflet/leaflet.js"></script>
		<script src="./leaflet/easy-button.js"></script>
		<script src="./leaflet/leaflet.groupedlayercontrol.min.js"></script>
		<script src="./leaflet/jquery.min.js"></script>
		<script src="./leaflet/leaflet.edgebuffer.js"></script>
		
		<link rel="stylesheet" href="./leaflet/leaflet.css"/>
		<link rel="stylesheet" href="./leaflet/easy-button.css"/>
		<link rel="stylesheet" href="./leaflet/leaflet.groupedlayercontrol.min.css"/>
		<link href='https://css.gg/airplane.css' rel='stylesheet'>

		<style>

			body {
				padding: 0;
				margin: 0;
				font-family: Arial !important;
				background-color: white;
			}	
	
			.leaflet-container .leaflet-touch .leaflet-fade-anim .leaflet-grab .leaflet-touch-drag .leaflet-touch-zoom{
				background-color: white;
			}
	
			html, body, #map {
				height: 91vh;
				width: 100%;
				font-weight: normal;
				overflow: hidden;
				font-family: Arial !important;
				background-color: white;
			}
			
			p{
				font-family: Arial !important;
				padding: 0;
				margin: 0;
			}

			input .glass{
				font-family: Arial !important;
			}
	
			.leaflet-popup-close-button{
				color: black;
				font-family: Arial;
			}
	
			.leaflet-popup-content {
				margin: 5px 12px;
				line-height: 1.4;
				text-align: center;
				font-family: Arial !important;
				font-weight: normal;
			}
	
			.leaflet-tooltip.my-labels {
				background-color: transparent;
				border: transparent;
				box-shadow: none;
				font-weight: normal;
				font-size: 14px;
				font-family: Arial !important;
			}
	
			.leaflet-touch .leaflet-bar a {
				color: gray;
				font-family: Arial !important;
			}
			.leaflet-control-zoom-out .leaflet-control-zoom-in{
				color: gray;
				font-family: Arial !important;
			}
	
			.leaflet-control-layers-expanded {
				color: gray;
				font-family: Arial !important;
			}
	
			.leaflet-touch:hover .leaflet-bar a:hover {
				color: dimgray;
			}
	
			.leaflet-control-layers-expanded:hover {
				color: dimgray;
			}
	
			.leaflet-touch .leaflet-control-geosearch a.reset{
				color: gray;
				font-family: Arial !important;
			}
	
			.leaflet-touch:hover .leaflet-control-geosearch a.reset:hover{
				color: dimgray;
			}
	
			.leaflet-control-geosearch form input {
				background-color: white;
			}
	
			.leaflet-popup-content p {
				width: 100%;
				text-align: center;
				margin: 0;
			}
			
			.gg-track {
				color: gray;
				box-sizing: border-box;
				position: relative;
				display: block;
				transform: scale(var(--ggs,1));
				width: 10px;
				height: 10px;
				border: 2px solid transparent;
				box-shadow:
					0 0 0 2px,
					inset 0 0 0 10px;
				border-radius: 100px;
				margin-top: 75%;
				margin-left: 5%;
			}
	
			.gg-track:hover {
				color: dimgray;
			}
	
			.gg-track::after,
			.gg-track::before {
				content: "";
				display: block;
				box-sizing: border-box;
				position: absolute;
				border-radius: 3px
			}

			.gg-track::before {
				border-left: 4px solid;
				border-right: 4px solid;
				width: 18px;
				height: 2px;
				left: -6px;
				top: 2px
			}

			.gg-track::after {
				width: 2px;
				height: 18px;
				border-top: 4px solid;
				border-bottom: 4px solid;
				left: 2px;
				top: -6px
			}
	
			.gg-track-gray {
				color: lightgrey;
				box-sizing: border-box;
				position: relative;
				display: block;
				transform: scale(var(--ggs,1));
				width: 10px;
				height: 10px;
				border: 2px solid transparent;
				box-shadow:
					0 0 0 2px,
					inset 0 0 0 10px;
				border-radius: 100px;
				margin-top: 47%;
				margin-left: 23%;
			}

			.gg-track-gray::after,
			.gg-track-gray::before {
				content: "";
				display: block;
				box-sizing: border-box;
				position: absolute;
				border-radius: 3px
			}

			.gg-track-gray::before {
				border-left: 4px solid;
				border-right: 4px solid;
				width: 18px;
				height: 2px;
				left: -6px;
				top: 2px
			}

			.gg-track-gray::after {
				width: 2px;
				height: 18px;
				border-top: 4px solid;
				border-bottom: 4px solid;
				left: 2px;
				top: -6px
			}
	
			.gg-arrow-down {
				color: gray;
				box-sizing: border-box;
				position: relative;
				display: block;
				transform: scale(var(--ggs,1));
				width: 22px;
				height: 22px
			}
			
			.gg-arrow-down::after,
			.gg-arrow-down::before {
				content: "";
				display: block;
				box-sizing: border-box;
				position: absolute;
				bottom: 4px
			}

			.gg-arrow-down::after {
				width: 8px;
				height: 8px;
				border-bottom: 2px solid;
				border-left: 2px solid;
				transform: rotate(-45deg);
				left: 7px
			}

			.gg-arrow-down::before {
				width: 2px;
				height: 16px;
				left: 10px;
				background: currentColor
			}

			#arrowButton {
				height: 44px; 
				width: 44px;
			}

			span.backButton {
				position: relative;
				bottom: 8px;
				color: gray;
				font-size: 9px;
			}

			i.gg-arrow-down {
				/* text-align: center; */
				position: relative;
				left: 1px;
				top: 2px;
			}

			td{
				margin: 0;
				padding: 0;
			}

			input[type="number"] {
				-webkit-appearance: textfield;
				-moz-appearance: textfield;
				appearance: textfield;
			}

			input[type=number]::-webkit-inner-spin-button,
			input[type=number]::-webkit-outer-spin-button {
				-webkit-appearance: none;
			}

			.number-input {
				border: 2px solid #ddd;
				display: inline-flex;
				background-color: #ffffff;
			}

			.number-input,
			.number-input * {
				box-sizing: border-box;
			}

			.number-input button {
				outline:none;
				-webkit-appearance: none;
				background-color: transparent;
				border: none;
				align-items: center;
				justify-content: center;
				width: 1.5rem;
				height: 1.5rem;
				cursor: pointer;
				margin: 0;
				position: relative;
			}

			.number-input button:before,
			.number-input button:after {
				display: inline-block;
				position: absolute;
				content: '';
				width: 0.9rem;
				height: 2px;
				background-color: #212121;
				transform: translate(-50%, -50%);
			}
			
			.number-input button.plus:after {
				transform: translate(-50%, -50%) rotate(90deg);
			}

			.number-input input[type=text] {
				font-family: arial;
				max-width: 5rem;
				padding: .5rem;
				border: solid #ddd;
				border-width: 0 2px;
				font-size: 0.9rem;
				height: 1.5rem;
				font-weight: bold;
				text-align: center;
				background-color: #ffffff;
			}

			.teleportButton{
				color: black;
				width: 80px;
				margin: 3px 10px;
				padding: 0;
				font-family: Arial !important;
				font-weight: normal;
				background-color: #ffffff;
				border: solid #ddd;
				border-width: 2px;
				height: 1.5rem;
				font-size: 0.9rem;
			}

		  </style>
	</head>

	<body id="documentBody">
		<div id="map"></div>
	</body>

	<script>
		var browserDebug = 0;
		var mapState = {
			lat: '',
			lon: '',
			head: '',
			style: ''
		};
		var map;
		var toggle;
		var newMarker;
		var airplane;
		var follow = true;
		var heading = 0;
		var altitude = 0;
		var speed = 0;

		window.addEventListener("DOMContentLoaded", function() {
			loadMap(47.50737, 19.04611);
			// Get the message reference
			var messageElement = document.getElementById('message');

			// Register the event listener
			window.addEventListener('message', receiveMessage);
		});

		function loadMap(lat, lon){

			// Create Leaflet map on map element.

			var initMapCenter = [47.442, 8.23];
			var initMapZoom = 8;
			var southWest = new L.LatLng(-90, -180),
            northEast = new L.LatLng(90, 180),
            maxExtent = new L.LatLngBounds(southWest, northEast);

			var streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap</a>',
					maxZoom: 18,
					minZoom: 4,
					format: 'image/png',
					transparent: true,
					subdomains: ['a', 'b', 'c']
				});

			var monochrome = L.tileLayer('http://{s}.tile.stamen.com/toner/{z}/{x}/{y}.{ext}', {attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.',
					ext: 'png',
					minZoom: 0,
					maxZoom: 14,
					subdomains: 'abcd'
				});

			var terrain = L.tileLayer('http://{s}.tile.stamen.com/terrain/{z}/{x}/{y}.{ext}', {attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.',	
					ext: 'png',
					minZoom: 0,
					maxZoom: 14,
					subdomains: 'abcd'
				});

			var water = L.tileLayer('http://{s}.tile.stamen.com/watercolor/{z}/{x}/{y}.{ext}', 
					{attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://creativecommons.org/licenses/by-sa/3.0">CC BY SA</a>.',
					ext: 'png',
					minZoom: 0,
					maxZoom: 14,
					subdomains: 'abcd'
				});

			var airspaces = L.tileLayer('http://{s}.tile.maps.openaip.net/geowebcache/service/tms/1.0.0/openaip_basemap@EPSG%3A900913@png/{z}/{x}/{y}.{ext}', {
					attribution: '<a href="https://www.openaip.net/">openAIP Data</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-NC-SA</a>)',
					ext: 'png',
					maxZoom: 12,
					minZoom: 8,
					tms: true,
					detectRetina: true,
					subdomains: '12',
					format: 'image/png',
					transparent: true
				});

			var openaip_cached_hotspot = new L.TileLayer('http://{s}.tile.maps.openaip.net/geowebcache/service/tms/1.0.0/openaip_approved_hotspots@EPSG%3A900913@png/{z}/{x}/{y}.png', {
				maxZoom: 14,
				minZoom: 10,
				tms: true,
				detectRetina: true,
				subdomains: '12',
				format: 'image/png',
				transparent: true
			});
			

			var none = L.tileLayer('http://{s}./{z}/{x}/{y}.{ext}', {
					ext: 'png',
					tms: true,
					minZoom: 100,
					maxZoom: 100,
					});

			var baseMaps = {
				"Streets": streets,
				"Monochrome": monochrome,
				"Terrain": terrain,
				"Water": water
			}

			var groupedOverlays = {
				"Airspaces" : {
					'On': airspaces,
					'Off': none
				},
			};

			var baseMaps = {
				"Streets": streets,
				"Monochrome": monochrome,
				"Terrain": terrain,
				"Water": water
			}

			var groupedOverlays = {
				"Airspaces" : {
					'On': airspaces,
					'Off': none
				},
			};

			var options = {
				// Make the "Landmarks" group exclusive (use radio inputs)
				exclusiveGroups: ["Airspaces"],
				// Show a checkbox next to non-exclusive group labels for toggling all
				groupCheckboxes: true
			};

			// Where you want to render the map.
			var element = document.getElementById('map');

			var openaip_basemap_osm = L.featureGroup([streets, airspaces, openaip_cached_hotspot]);

			map = L.map('map', {
				center: [49.47211425492292, 9.040833186453408],
				zoom: 8,
				edgeBufferTiles: 5,
				layers: [openaip_basemap_osm],
				bounds: maxExtent
			});

			function reloadImg() { // reload image by changing its src
				var src = $(this).attr("src");
				var i = src.lastIndexOf('?');
				if (i > 0) { // remove previous cache string
					src = src.substring(0, i);
				}
				$(this).attr("src", src + "?nocache=" + (Math.random() * 1000));
			}

			map.on('layeradd', function(ILayer) { // on adding a new tile
				if ($.isFunction(ILayer.layer.getContainer)) { // get the container holding the images
					$("img", ILayer.layer.getContainer()).error(reloadImg); // apply error handling event
				}
			});

			map.on('click', function(e) {
				if (map.hasLayer(newMarker)) {
					map.removeLayer(newMarker);
				} else {
					newMarker = new L.marker(e.latlng).addTo(map);
					newMarker.bindPopup("<table><tr><td><p style='font-size: 1.5rem'>Teleport<p></td></tr><tr><td style='text-align:left; padding:0; font-size: 14px'>&nbsp;Altitude (ft): </td></tr><tr><td><div class='number-input'><button onclick='altitudeDwn()'></button><input id='altitudeInput' class='quantity' min='0' name='quantity' value= " + Math.round(altitude) + " type='text'><button onclick='altitudeUp()' class='plus'></button></div></td></tr><tr><td style='text-align:left; padding:0; font-size: 14px'>&nbsp;Heading (deg): </td><tr><td><div class='number-input'><button onclick='headingDwn()'></button><input id='headingInput' class='quantity' min='0' name='quantity' value= " + Math.round(heading) + " type='text'><button onclick='headingUp()' class='plus'></button></div></td></tr><tr><td style='text-align:left; padding:0; font-size: 14px'>&nbsp;Airspeed (kt): </td></tr><tr><td><div class='number-input'><button onclick='speedDwn()'></button><input id='speedInput' class='quantity' min='0' name='quantity' value= " + Math.round(speed) + " type='text'><button onclick='speedUp()' class='plus'></button></div></td></tr><br><tr><td><span style='margin-top: 15px'><button style='margin-top:10px; text-align: center' class='teleportButton' onclick='teleport(" + e.latlng.lat + "," + e.latlng.lng + ")' >OK</button></span></td></tr></table>").openPopup();
					var slides = document.getElementsByClassName("leaflet-popup-close-button");
					for (var i = 0; i < slides.length; i++) {
						slides[i].innerHTML = '<span>x</font>';
					}
				}
				follow = false;
				toggle.enable();
			});

			toggle = L.easyButton('gg-track', function() {
				follow = true;
				toggle.disable();
				if (map.hasLayer(newMarker)) {
					map.removeLayer(newMarker);
				}
			}).addTo(map);

			toggle.disable();

			follow = true;
			toggle.disable();

			//map.invalidateSize()

			map.on("dragstart", function(e) {
				toggle.enable();
				follow = false;
			});

			map.on('popupclose', function(e) {
				if (map.hasLayer(newMarker)) {
					map.removeLayer(newMarker);
				}
				follow = true;
				toggle.disable();
			});

			L.control.groupedLayers(baseMaps, groupedOverlays, options).addTo(map);

			var toggle2 = L.easyButton({
				id: 'arrowButton', // an id for the generated button
				position: 'topright', // inherited from L.Control -- the corner it goes in
				type: 'replace', // set to animate when you're comfy with css
				leafletClasses: true, // use leaflet classes to style the button?
				states: [{ // specify different icons and responses for your button
					stateName: 'get-center',
					title: '',
					icon: '<i id="arrow"; class="gg-arrow-down"></i>' + '<span class="backButton">3kts</span><br>',

				}]
			}).addTo(map);


			function showAirspaceLabels() {
				if (map.getZoom() >= 10 && !map.hasLayer(openaip_cached_hotspot)) {
					openaip_cached_hotspot.addTo(map);
				} else {
					map.removeLayer(openaip_cached_hotspot);
				}
			}

			function updateMapSystem() {
				showAirspaceLabels();
			}

			setInterval(updateMapSystem, 1000);

			var iconAirplane = L.divIcon({
				html: '<div id="imageAirplane"><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KIDx0aXRsZS8+CgogPGc+CiAgPHRpdGxlPmJhY2tncm91bmQ8L3RpdGxlPgogIDxyZWN0IGZpbGw9Im5vbmUiIGlkPSJjYW52YXNfYmFja2dyb3VuZCIgaGVpZ2h0PSIxMDIiIHdpZHRoPSIxMDIiIHk9Ii0xIiB4PSItMSIvPgogPC9nPgogPGc+CiAgPHRpdGxlPkxheWVyIDE8L3RpdGxlPgogIDxwYXRoIGZpbGw9IiNmZjJlNjMiIHN0cm9rZT0ibnVsbCIgaWQ9InN2Z18xIiBkPSJtOTcuOTg4MDU5LDQuOTU2MzI3YTkuMjA3NDg1LDkuMTIxMDkxIDAgMCAwIC0xNC4wMTU4MDYsLTEuMTcwMzU3bC0xOC4zMzYyNjQsMTguMTY0NTQ5bC00Ny45MjQzNDcsLTEzLjk2MzgyYTQuMTI4NDU3LDQuMDg5NzE5IDAgMCAwIC00LjA4NTQyNywxLjAzMjAwOGwtNS4yODc0MDQsNS4yMzcxNjlhNC4xMzAzMTksNC4wOTE1NjQgMCAwIDAgMC42ODkzNDYsNi4zMzYzODdsMzUuMzE0NTY1LDIyLjQ1MTM5MmwtMy4yMjE0OTUsMy4xOTE1NTVhNjguNjEyOTAxLDY3Ljk2OTEwMiAwIDAgMCAtNy43MzE4NDksOS4xOTEyOTVsLTI0LjQxMjM3NywtMi41Nzk4NGE0LjE1MDIyNSw0LjExMTI4NCAwIDAgMCAtMy4zNzQzNjEsMS4xODE0NzRsLTMuMzgzMzM0LDMuMzUxMDYxYTQuMTQ5ODYzLDQuMTEwOTI0IDAgMCAwIDAuNjkyODI5LDYuMzY2MzM4bDIwLjQzMjY5OCwxMi45ODk1ODFsMTMuMTMyNTI0LDIwLjI3MTI2M2E0LjEyMDIzMyw0LjA4MTU3MiAwIDAgMCA2LjM4MDk5NywwLjY4MTg3MWwzLjQxODkzOCwtMy4zODcwNzRhNC4xMjA4NjIsNC4wODIxOTUgMCAwIDAgMS4xODM0MjYsLTMuMzE5MzYxbC0yLjYwNTAwMiwtMjQuMTk2OTI0YTY4LjU3MTYxMyw2Ny45MjgyMDEgMCAwIDAgOS4yNzc5NjgsLTcuNjU5NTg5bDMuMjIxNDk1LC0zLjE5MTAwNGwyMi42NDE1MzIsMzQuOTQ3NDU3YTQuMTY0NDI0LDQuMTI1MzQ5IDAgMCAwIDYuNDQ5MTU4LDAuNjg5MTA4bDUuMjQyNTYxLC01LjE5MzcwNWE0LjE2NDY2NSw0LjEyNTU4OCAwIDAgMCAxLjA1MDQ0MiwtNC4wODEyNjFsLTE0LjA5MDEzNSwtNDcuNDU0NzgzbDE3Ljk4ODQ3MSwtMTcuODE5OTQ3YzMuMjQxMTExLC0zLjIxMDk4NyA0LjAyOTg2OCwtOC4zODAzNzIgMS4zNTA4NTIsLTEyLjA2NDg0NXoiLz4KIDwvZz4KPC9zdmc+" /></div>',
				iconSize: [100, 100],
				iconAnchor: [50, 50],
				className: 'currentAirplane'
			});

			airplane = L.marker([47.442, 10.23], {
				icon: iconAirplane
			}).addTo(map);
		}

		function altitudeUp() {
			//console.log('altitude Up');
			var altitudeInput = parseFloat(document.getElementById('altitudeInput').value);
			document.getElementById('altitudeInput').value = (altitudeInput + 1);
		}

		function altitudeDwn() {
			//console.log('altitude Down');
			var altitudeInput = parseFloat(document.getElementById('altitudeInput').value);
			document.getElementById('altitudeInput').value = (altitudeInput - 1);
		}

		function headingUp() {
			//console.log('heading Up');
			var headingInput = parseFloat(document.getElementById('headingInput').value);
			document.getElementById('headingInput').value = (headingInput + 1);
		}

		function headingDwn() {
			//console.log('heading Down');
			var headingInput = parseFloat(document.getElementById('headingInput').value);
			document.getElementById('headingInput').value = (headingInput - 1);
		}

		function speedUp() {
			//console.log('speed Up');
			var speedInput = parseFloat(document.getElementById('speedInput').value);
			document.getElementById('speedInput').value = (speedInput + 1);
		}

		function speedDwn() {
			//console.log('speed Down');
			var speedInput = parseFloat(document.getElementById('speedInput').value);
			document.getElementById('speedInput').value = (speedInput - 1);
		}

		function setPosition(lat, lng) {
			var pos = new L.LatLng(lat, lng);
			airplane.setLatLng(pos).update();
			if (follow == true) {
				map.panTo(pos);
			}
		}

		function setRotation(deg) {
			$('#imageAirplane').css('transform', 'rotate(' + Math.round(deg - 45) + 'deg)  scale(0.3)');
			$('#imageAirplane').css('fill', 'red');
		}

		function setWind(direction, speed) {
			$('i#arrow').css('transform', 'rotate(' + Math.round(direction) + 'deg)');
			$('.backButton').text(Math.round(speed) + ' kt');
		}

		function teleport(lat, lng) {
			var altInput = parseFloat(document.getElementById('altitudeInput').value);
			var headingInput = parseFloat(document.getElementById('headingInput').value);
			var speedInput = parseFloat(document.getElementById('speedInput').value);
			postMessage('map:' + lat + '_' + lng + '_' + altInput + '_' + headingInput + '_' + speedInput)
			if (map.hasLayer(newMarker)) {
				map.removeLayer(newMarker);
			}
		}

		// Receive controls from parent page
		function receiveMessage(e) {
			if (browserDebug == 0) {
				var request = e.data;
				console.log(e.data);
				// Call function:
				var latlng = request.split("_");
				altitude = (latlng[2]);
				heading = latlng[3] * 180 / Math.PI;
				speed = (latlng[4]);
				$('#map').css('height', latlng[7] - 10 + 'px');
				$('body').css('height', latlng[7] - 10 + 'px');
				$('html').css('height', latlng[7] - 10 + 'px');
				setPosition(latlng[0], latlng[1]);
				setRotation(heading);
				setWind(latlng[5], latlng[6]);
			}
		}

		// Send postMessage
		function postMessage(message) {
			toggle.disable();
			if (browserDebug == 0) {
				// Get the iFrame and the button reference
				window.parent.postMessage(message, 'coui://html_ui');
				//console.log('Postmessage send: ' + message);
			}
		}

    </script>

</html>
